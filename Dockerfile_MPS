# Use a lightweight Python base image with Python 3.10
FROM python:3.10-slim

# Install essential system-level dependencies and build tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    wget \
    ca-certificates \
    build-essential \
    gcc \
    g++ \
    libgl1-mesa-glx \
    gdal-bin \
    libgdal-dev \
    && rm -rf /var/lib/apt/lists/*

# Set the path for GDAL
ENV CPLUS_INCLUDE_PATH=/usr/include/gdal
ENV C_INCLUDE_PATH=/usr/include/gdal

# Install Miniforge to manage Conda environments
RUN curl -sLo /tmp/miniforge.sh https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-$(uname -m).sh \
    && bash /tmp/miniforge.sh -b -p /opt/conda \
    && rm /tmp/miniforge.sh

# Update PATH to use Conda by default
ENV PATH="/opt/conda/bin:${PATH}"

# Create a Conda environment with Python 3.10 and install geospatial libraries
RUN /opt/conda/bin/conda create -n myenv python=3.10 -y \
    && /opt/conda/bin/conda run -n myenv conda install -c conda-forge -y gdal fiona geopandas \
    && /opt/conda/bin/conda clean -afy

# Install the required versions of PyTorch, TorchVision, and Torchaudio from PyPI
RUN /opt/conda/bin/conda run -n myenv pip install torch==2.4.1 torchvision==0.19.1 torchaudio==2.4.1

# Install additional Python packages using pip
RUN /opt/conda/bin/conda run -n myenv pip install --no-cache-dir \
    numpy \
    scipy \
    pandas \
    tqdm \
    matplotlib \
    seaborn \
    jupyterlab \
    scikit-learn \
    opencv-python-headless \
    tensorboard \
    google-streetview \
    exifread \
    scikit-image

# Expose the port for JupyterLab
EXPOSE 8888

# Set the working directory
WORKDIR /home/user

# Entry point: Check GPU availability and start JupyterLab
CMD ["bash", "-c", "/opt/conda/bin/conda run -n myenv python -c \"import torch; print('Checking GPU backends...'); print('CUDA available:', torch.cuda.is_available()); print('MPS available:', torch.backends.mps.is_available()); print('Using:', 'CUDA' if torch.cuda.is_available() else 'MPS' if torch.backends.mps.is_available() else 'CPU')\" && /opt/conda/bin/conda run -n myenv jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root"]
