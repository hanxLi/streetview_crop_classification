# Use NVIDIA CUDA base image with CUDA 12.1 support
FROM nvidia/cuda:12.1.0-devel-ubuntu20.04

# Prevent interactive prompts (e.g., timezone setup)
ENV DEBIAN_FRONTEND=noninteractive

# Install essential system dependencies and build tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    wget \
    ca-certificates \
    build-essential \
    gcc \
    g++ \
    libgl1-mesa-glx \
    gdal-bin \
    libgdal-dev \
    && rm -rf /var/lib/apt/lists/*

# Set GDAL include paths
ENV CPLUS_INCLUDE_PATH=/usr/include/gdal
ENV C_INCLUDE_PATH=/usr/include/gdal

# Install Miniforge for Conda environments
RUN curl -sLo /tmp/miniforge.sh https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh \
    && bash /tmp/miniforge.sh -b -p /opt/conda \
    && rm /tmp/miniforge.sh

# Update PATH to use Conda by default
ENV PATH="/opt/conda/bin:${PATH}"

# Create a Conda environment with Python 3.10 and install ML libraries
RUN /opt/conda/bin/conda create -n myenv python=3.10 -y \
    && /opt/conda/bin/conda run -n myenv conda install -c conda-forge -y \
       gdal fiona geopandas \
    && /opt/conda/bin/conda clean -afy

# Install PyTorch with CUDA support and other Python packages via pip
RUN /opt/conda/bin/conda run -n myenv pip install --no-cache-dir \
    torch==2.4.1+cu121 torchvision==0.19.1+cu121 torchaudio==2.4.1 --extra-index-url https://download.pytorch.org/whl/cu121 \
    numpy scipy pandas tqdm matplotlib seaborn jupyterlab scikit-learn \
    opencv-python-headless tensorboard google-streetview exifread scikit-image

# Expose JupyterLab port
EXPOSE 8888

# Set working directory
WORKDIR /home/user

# Entry point: Check GPU availability and start JupyterLab
CMD ["bash", "-c", "/opt/conda/bin/conda run -n myenv python -c \"import torch; print('Checking GPU backends...'); print('CUDA available:', torch.cuda.is_available()); print('Using:', 'CUDA' if torch.cuda.is_available() else 'CPU')\" && /opt/conda/bin/conda run -n myenv jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root"]
